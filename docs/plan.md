# 実装計画書

## 1. プロジェクト実装概要

### 1.1 開発ステータス
- **現在のバージョン**: v2.0（分散BIシステム）
- **実装状況**: コア機能実装完了、テスト・最適化フェーズ

### 1.2 v2.0の主要機能
- サイクル駆動型の動作モデル
- 分散複数デバイス対応
- バッファリング＋時系列連結処理
- 短文生成（2~3トークン）
- タイムスタンプ管理

---

## 2. アーキテクチャ設計

### 2.1 モジュール構成

```
CCBT-2025-Parallel-Botanical-Garden-Proto/
├── main.py                    # エントリーポイント
├── bi/                        # BI関連モジュール
│   ├── __init__.py
│   ├── controller.py         # BIController クラス
│   ├── models.py             # BIInputData データクラス
│   └── utils.py              # Soft Prefix生成ユーティリティ
├── app/                       # アプリケーション層
│   ├── __init__.py
│   └── controller.py         # AppController クラス
├── api/                       # API層
│   ├── llm.py                # LLMクライアント
│   ├── tts.py                # TTSクライアント
│   ├── osc.py                # OSCサーバー/クライアント
│   └── utils.py              # LLM/TTS設定
├── stackflow/                 # StackFlow通信
│   └── utils.py
├── config/                    # 設定ファイル
│   └── config.json
└── tests/                     # テストスクリプト
    ├── test_bi.py
    └── test_multi_target.py
```

### 2.2 BIController 状態機械

```
     ┌────────────┐
     │  RECEIVING │ (3秒)
     │  ・入力受付 │
     │  ・フィルタ │
     └──────┬─────┘
            ↓
     ┌─────────────┐
     │ GENERATING  │
     │ ・データ連結 │
     │ ・LLM生成   │
     └──────┬──────┘
            ↓
     ┌─────────────┐
     │   OUTPUT    │
     │ ・バッファ確認│
     │ ・OSC送信   │
     │ ・TTS再生   │
     └──────┬──────┘
            ↓
     ┌─────────────┐
     │   RESTING   │ (1秒)
     │  ・待機     │
     └──────┬──────┘
            ↓
       (RECEIVINGに戻る)
```

### 2.3 データ構造

```python
@dataclass
class BIInputData:
    timestamp: float        # UNIX timestamp
    text: str              # 入力テキスト
    source_type: str       # "human" or "BI"
    lang: str             # 言語コード
```

---

## 3. 実装済み機能

### 3.1 コア機能（✅ 完了）
- [x] BIControllerクラス（4段階サイクル処理）
- [x] AppControllerクラス（OSCサーバー管理）
- [x] BIInputDataモデル
- [x] Soft Prefix生成ユーティリティ
- [x] モジュール分離（app/, bi/ディレクトリ）

### 3.2 OSCエンドポイント（✅ 完了）
- [x] `/bi/input` - 入力データ受付
- [x] `/bi/stop` - サイクル停止
- [x] `/bi/status` - ステータス取得
- [x] 自動起動 - アプリケーション起動時にサイクルが自動開始

### 3.3 設定ファイル（✅ 完了）
- [x] サイクル設定（receive_duration, rest_duration, max_data_age）
- [x] ターゲットデバイスリスト

### 3.4 データフィルタリング（✅ 完了）
- [x] タイムスタンプによる古いデータ破棄
- [x] 時系列順データ連結

---

## 4. 今後のタスク

### 4.1 テストと検証（優先度: 高）
- [ ] 単体テスト実装
  - BIController各フェーズの動作確認
  - タイムスタンプフィルタリング検証
- [ ] 統合テスト実装
  - 複数デバイス間通信テスト
  - 長時間稼働テスト
  - メモリリークチェック
- [ ] パフォーマンス測定
  - サイクル時間の測定
  - LLM/TTS応答時間の測定

### 4.2 ドキュメント整備（優先度: 中）
- [ ] README更新
  - v2.0機能説明
  - セットアップガイド
  - 使用方法
- [ ] 設定ファイルサンプル追加
  - 複数デバイス構成例

### 4.3 将来的な拡張（優先度: 低）
- [ ] Excelトポロジー設定
  - pandasによるExcel読み込み
  - 動的トポロジー管理
- [ ] 可視化ダッシュボード
  - サイクル状態の可視化
  - バッファ内容の表示
  - ネットワークトポロジー図
- [ ] 動的設定変更
  - `/bi/set_targets`エンドポイント
  - ランタイムでの送信先変更

---

## 5. 実装の重要ポイント

### 5.1 非同期処理
- asyncio ベースのイベントループ
- OSCサーバーとBIサイクルの並行動作
- StackFlow TCP通信の非同期処理

### 5.2 エラーハンドリング
- 各フェーズでの例外キャッチ
- StackFlow接続エラー時の再接続
- 詳細なログ出力（loguru使用）

### 5.3 状態管理
- BIControllerの状態遷移管理
- 入力バッファの適切なクリア
- タイムスタンプベースのデータ有効期限管理

---

## 6. 技術的な考慮事項

### 6.1 パフォーマンス
- LLM推論速度: 目標1秒以内
- TTS生成速度: 目標1秒以内に再生開始
- サイクル全体: 約5~8秒

### 6.2 拡張性
- 新規言語追加が容易（LLM_SETTINGSに追加）
- モデル切り替えが設定ファイルで可能
- 送信先デバイスの動的追加対応

### 6.3 保守性
- モジュール化されたアーキテクチャ
- 型ヒントによる可読性向上
- 詳細なログ出力

---

## 7. 既知の課題・制約

### 7.1 技術的制約
- M5Stack LLM Compute Kitでのみ動作
- StackFlow APIに依存
- オフライン動作には翻訳モデルの事前インストールが必要

### 7.2 機能的制約
- LLM出力は最大64トークン
- TTS音声はリアルタイム再生のみ
- OSCプロトコルのみ対応

### 7.3 今後の改善点
- 長時間稼働時のメモリ使用量監視
- ネットワーク遅延への対策強化
- 複数デバイス間の同期精度向上

---

このドキュメントは実装の進捗に応じて随時更新されます。
