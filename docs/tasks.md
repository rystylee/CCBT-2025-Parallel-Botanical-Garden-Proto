# タスクリスト

## 概要
このドキュメントは、CCBT-2025-Parallel-Botanical-Garden-Proto v2.0（分散BIシステム）の開発タスクを管理します。

---

## 1. ドキュメント更新（完了）

- [x] 要件定義書を新仕様に基づいて更新
- [x] 実装計画書を新仕様に基づいて更新
- [x] タスクリストを新仕様に基づいて更新

---

## 2. コア機能実装（優先度: 高）

### 2.1 設定ファイル拡張
- [ ] `config/config.json`に以下のセクションを追加
  - `device`: デバイスタイプ（"1st_BI" or "2nd_BI"）
  - `cycle`: サイクル設定（receive_duration, rest_duration, max_data_age）
  - `targets`: 送信先デバイスリスト
- [ ] 既存の設定ファイルをバックアップ
- [ ] 設定ファイルのバリデーション機能追加

**実装場所**: [config/config.json](../config/config.json)
**予定期間**: 1日

### 2.2 BIControllerクラス実装
- [ ] `BIController`クラスの基本構造を実装
  - [ ] `__init__`: 初期化、各種クライアント設定
  - [ ] `start_cycle()`: サイクル開始メソッド
  - [ ] `_receiving_phase()`: 入力受付期間処理
  - [ ] `_generating_phase()`: 生成期間処理
  - [ ] `_output_phase()`: 出力期間処理
  - [ ] `_resting_phase()`: 休息期間処理
  - [ ] `_filter_old_data()`: タイムスタンプフィルタリング
  - [ ] `_concatenate_inputs()`: 入力データ連結
  - [ ] `add_input()`: 入力データ追加
- [ ] 状態遷移ロジックの実装
- [ ] デバイスタイプ別のフィルタリング実装（2nd BI対応）
- [ ] エラーハンドリングの追加

**実装場所**: [app.py](../app.py)
**予定期間**: 3日

### 2.3 データクラス実装
- [ ] `BIInputData`データクラスを実装
  - timestamp: float
  - text: str
  - source_type: str
  - lang: str

**実装場所**: [app.py](../app.py) または新規 `models.py`
**予定期間**: 0.5日

### 2.4 OSCハンドラー実装
- [ ] `/bi/input`エンドポイント実装
  - タイムスタンプ、テキスト、ソースタイプ、言語を受け取る
  - BIControllerのバッファに追加
- [ ] `/bi/start`エンドポイント実装
  - BIサイクルを開始
- [ ] `/bi/stop`エンドポイント実装
  - BIサイクルを停止
- [ ] `/bi/status`エンドポイント実装
  - 現在のステータス（状態、バッファサイズ等）を返す
- [ ] レガシーエンドポイントの維持
  - `/process`, `/process/llm`, `/process/tts`

**実装場所**: [app.py](../app.py), [api/osc.py](../api/osc.py)
**予定期間**: 1日

### 2.5 OSCクライアント拡張
- [ ] `send_to_target()`メソッド実装
  - 特定のターゲットデバイスへメッセージ送信
- [ ] `/bi/output`メッセージ送信機能
  - タイムスタンプ付き生成テキストの送信

**実装場所**: [api/osc.py](../api/osc.py)
**予定期間**: 0.5日

### 2.6 LLMクライアント修正
- [ ] `max_tokens`パラメータを3に変更
- [ ] インストラクションプロンプトを「2~3トークン生成」に変更
- [ ] `api/utils.py`のLLM_SETTINGSを更新

**実装場所**: [api/llm.py](../api/llm.py), [api/utils.py](../api/utils.py)
**予定期間**: 0.5日

---

## 3. テスト実装（優先度: 高）

### 3.1 テストスクリプト作成
- [ ] `test_bi.py`を作成
  - `/bi/start`でサイクル開始
  - `/bi/input`で複数の入力を送信（human, BI両方）
  - `/bi/status`でステータス確認
  - `/bi/stop`でサイクル停止
- [ ] 複数デバイス間の通信テスト用スクリプト
- [ ] タイムスタンプフィルタリングのテスト

**実装場所**: 新規 `test_bi.py`
**予定期間**: 1日

### 3.2 単体テスト
- [ ] BIControllerの各フェーズが正しく動作することを確認
- [ ] タイムスタンプフィルタリングが正しく動作することを確認
- [ ] デバイスタイプ別フィルタリングが正しく動作することを確認
- [ ] データ連結が時系列順に行われることを確認

**実装場所**: 新規 `tests/test_bi_controller.py`
**予定期間**: 1日

### 3.3 統合テスト
- [ ] 1st BI → 2nd BI(複数) のデータフロー確認
- [ ] サイクルが無限ループで動作することを確認
- [ ] 長時間稼働テスト（1時間以上）
- [ ] メモリリークチェック

**実装場所**: 新規 `tests/test_integration.py`
**予定期間**: 2日

---

## 4. ドキュメント・補助ツール（優先度: 中）

### 4.1 READMEの更新
- [ ] v2.0の新機能説明を追加
- [ ] BIシステムの使い方を追加
- [ ] 設定ファイルの説明を更新
- [ ] 新しいOSCエンドポイントの説明を追加

**実装場所**: [README.md](../README.md)
**予定期間**: 0.5日

### 4.2 設定ファイルサンプル
- [ ] 1st BI用の設定ファイルサンプル作成
- [ ] 2nd BI用の設定ファイルサンプル作成
- [ ] 複数デバイス構成のサンプル

**実装場所**: `config/` ディレクトリ
**予定期間**: 0.5日

### 4.3 可視化ツール（オプション）
- [ ] サイクル状態を可視化するシンプルなダッシュボード
- [ ] 入力バッファの内容を表示
- [ ] ネットワークトポロジーの図示

**実装場所**: 新規 `tools/visualizer.py`
**予定期間**: 2日

---

## 5. 将来的な拡張（優先度: 低）

### 5.1 Excelトポロジー設定
- [ ] Excelファイルからトポロジーを読み込む機能
- [ ] pandasライブラリの追加
- [ ] Excelファイルのテンプレート作成

**実装場所**: 新規 `api/topology.py`
**予定期間**: 2日

### 5.2 動的トポロジー変更
- [ ] `/bi/set_targets`エンドポイント実装
- [ ] ランタイムでの送信先変更機能

**実装場所**: [app.py](../app.py), [api/osc.py](../api/osc.py)
**予定期間**: 1日

### 5.3 パフォーマンス最適化
- [ ] サイクル時間の詳細測定
- [ ] LLM生成速度の最適化
- [ ] メモリ使用量の監視と最適化
- [ ] プロファイリングツールの導入

**実装場所**: 各ファイル
**予定期間**: 3日

---

## 6. 実装スケジュール

### Week 1
- [x] ドキュメント更新（完了）
- [ ] 設定ファイル拡張
- [ ] データクラス実装
- [ ] BIControllerクラス実装（開始）

### Week 2
- [ ] BIControllerクラス実装（完了）
- [ ] OSCハンドラー実装
- [ ] OSCクライアント拡張
- [ ] LLMクライアント修正

### Week 3
- [ ] テストスクリプト作成
- [ ] 単体テスト実装
- [ ] 統合テスト実装

### Week 4
- [ ] README更新
- [ ] 設定ファイルサンプル作成
- [ ] バグ修正と最適化

---

## 7. 完了基準

各タスクは以下の基準を満たした場合に完了とみなします:

1. **実装完了**: コードが動作し、基本的なテストが通る
2. **コードレビュー**: セルフレビューまたはClaude Codeによるレビュー済み
3. **ドキュメント更新**: 関連ドキュメントが更新されている
4. **テスト追加**: 必要に応じてテストが追加されている
5. **コミット**: Gitにコミットされている（Conventional Commits形式）

---

## 8. 進捗トラッキング

### 現在の統計
- **完了済みタスク**: 3個（ドキュメント更新）
- **進行中タスク**: 0個
- **未着手タスク（高優先度）**: 13個
- **未着手タスク（中優先度）**: 5個
- **未着手タスク（低優先度）**: 5個

### 全体進捗
- **ドキュメント**: ✅ 100% 完了
- **コア機能**: ⏳ 0% 完了
- **テスト**: ⏳ 0% 完了
- **補助ツール**: ⏳ 0% 完了

---

## 9. ブロッカー・課題

現在のブロッカーはありません。

---

## 10. 次のアクション

1. 設定ファイル拡張から着手
2. BIControllerクラスの基本構造を実装
3. 簡単なテストスクリプトで動作確認

---

## 11. 変更履歴

| 日付 | 変更内容 | 担当者 |
|------|---------|--------|
| 2025-02-06 | v2.0向けにタスクリストを全面改訂 | Claude Code |

---

## 12. 参考リンク

- [要件定義書](requirements.md)
- [実装計画書](plan.md)
- [README.md](../README.md)
- [CLAUDE.md](../CLAUDE.md)

---

**このタスクリストは実装の進捗に応じて随時更新されます。**
