# タスクリスト

## 概要
CCBT-2025-Parallel-Botanical-Garden-Proto v2.0の開発タスク管理

**最終更新**: 2026-02-09

---

## 1. 完了済み機能 ✅

### 1.1 コア実装
- [x] モジュール分離（app/, bi/ディレクトリ）
- [x] BIControllerクラス（4段階サイクル処理）
- [x] AppControllerクラス（OSCサーバー管理）
- [x] BIInputDataモデル
- [x] Soft Prefix生成ユーティリティ

### 1.2 OSCエンドポイント
- [x] `/bi/input` - 入力データ受付
- [x] `/bi/stop` - サイクル停止
- [x] `/bi/status` - ステータス取得
- [x] サイクル自動開始 - アプリケーション起動時に自動開始

### 1.3 設定ファイル
- [x] サイクル設定（receive_duration, rest_duration, max_data_age）
- [x] 複数ターゲットデバイスリスト（networks.csv）
- [x] OSC受信ポート設定
- [x] LLM/TTS設定
- [x] Mixer PC設定（host, port）

### 1.4 データ処理
- [x] タイムスタンプフィルタリング（受信時に即座にチェック）
- [x] タイムスタンプ伝播（バッファ内の最新タイムスタンプを使用）
- [x] 時系列順データ連結
- [x] 入力バッファ管理
- [x] 空バッファ時のスキップ処理

### 1.5 OSC送信機能
- [x] BIデバイス間通信（/bi/input）
- [x] Mixer PC送信（/mixer）
- [x] Mixer PC受信テストスクリプト（tests/test_mixer_receiver.py）

### 1.6 ドキュメント
- [x] 要件定義書の更新
- [x] 実装計画書の更新
- [x] タスクリストの更新

---

## 2. 進行中のタスク 🔄

### 2.1 TTS音声出力のWAVファイル化（v2.1） - 実装完了、テスト待ち
**目的**: WAVファイル書き出し→FFmpeg変換（オプション）→tinyplay再生に変更

#### 完了済み
- [x] `api/tts.py`にWAVファイル生成・変換・再生機能を追加
- [x] `StackFlowTTSClient.speak_to_file()`メソッドの実装
- [x] `bi/controller.py`の`_output_phase()`を変更
- [x] `config/config.json`に`audio`設定を追加
- [x] `pyproject.toml`に`aiohttp`依存関係を追加
- [x] テストスクリプト作成（`tests/test_tts_wav_playback.py`）

#### 実機テスト待ち
- [ ] M5Stack実機での動作確認
- [ ] パフォーマンス測定（1秒以内に再生開始の目標達成確認）
- [ ] FFmpegとtinyplayコマンドの動作確認

---

## 3. 優先度: 高 🔴

### 3.1 テストスクリプト実装
**目的**: 各機能の動作確認

#### 3.1.1 単体テスト
- [ ] BIController各フェーズのテスト
  - `_receiving_phase()` の動作確認
  - `_generating_phase()` の動作確認
  - `_output_phase()` の動作確認
  - `_resting_phase()` の動作確認
- [ ] データフィルタリングのテスト
  - タイムスタンプフィルタリング（古いデータの即座拒否）
  - タイムスタンプ伝播（最新タイムスタンプの使用）
- [ ] データ連結のテスト
  - 時系列順ソート確認
  - 複数入力の連結確認

**実装場所**: `tests/test_bi_controller.py`（新規作成）

#### 3.1.2 統合テスト
- [ ] 複数デバイス間の通信テスト
- [ ] サイクルの無限ループ動作確認
- [ ] エラーハンドリングのテスト
- [ ] 長時間稼働テスト

**実装場所**: `tests/test_integration.py`（新規作成）

### 3.2 パフォーマンス測定
- [ ] サイクル時間の測定
  - 各フェーズの実行時間
  - サイクル全体の時間
- [ ] LLM推論速度の測定
- [ ] TTS生成・再生速度の測定
- [ ] メモリ使用量の監視

**実装場所**: `tests/test_performance.py`（新規作成）

---

## 4. 優先度: 中 🟡

### 4.1 ドキュメント整備
- [ ] README更新
  - v2.0の機能説明
  - セットアップガイド
  - 使用方法とサンプルコード
  - トラブルシューティング
- [ ] 設定ファイルサンプル作成
  - 複数デバイス構成例

### 4.2 エラーハンドリング強化
- [ ] StackFlow接続エラー時の詳細ログ
- [ ] OSC送信失敗時のリトライ機構
- [ ] 異常データ受信時の処理

### 4.3 ロギング改善
- [ ] ログレベルの最適化
- [ ] ログファイル出力対応（オプション）
- [ ] 重要イベントのログ強調

---

## 5. 優先度: 低 🟢

### 5.1 可視化ツール
- [ ] サイクル状態の可視化ダッシュボード
- [ ] 入力バッファの内容表示
- [ ] ネットワークトポロジー図の生成

**実装場所**: `tools/visualizer.py`（新規作成）

### 5.2 Excelトポロジー設定
- [ ] Excelファイルからのトポロジー読み込み
- [ ] pandasライブラリの追加
- [ ] Excelテンプレートの作成

**実装場所**: `api/topology.py`（新規作成）

### 5.3 動的設定変更
- [ ] `/bi/set_targets` エンドポイント実装
- [ ] ランタイムでの送信先変更機能
- [ ] 設定変更のバリデーション

### 5.4 パフォーマンス最適化
- [ ] LLM推論の最適化
- [ ] メモリ使用量の削減
- [ ] 非同期処理の最適化
- [ ] プロファイリングツールの導入

---

## 6. 今後の拡張案 💡

### 6.1 機能拡張
- [ ] HTTP APIサポート
- [ ] WebSocketによるリアルタイム通信
- [ ] 生成テキスト履歴の保存
- [ ] 音声ファイルのエクスポート機能

### 6.2 モデル拡張
- [ ] より大きなLLMモデル対応（1.5B, 3B等）
- [ ] カスタムファインチューニングモデル対応
- [ ] 複数モデルの同時実行

### 6.3 インターフェース拡張
- [ ] GUI管理画面
- [ ] Webブラウザからのコントロール
- [ ] MIDI CC対応

---

## 7. 進捗サマリー

### 実装状況
- **コア機能**: ✅ 100% 完了
- **テスト**: ⏳ 0% 完了
- **ドキュメント**: ✅ 100% 完了
- **拡張機能**: ⏳ 0% 完了

### タスク統計
- **完了済み**: 26個
- **進行中**: 0個
- **未着手（高優先度）**: 8個
- **未着手（中優先度）**: 7個
- **未着手（低優先度）**: 8個

---

## 8. 次のアクション

### 最優先タスク
1. **BIController各フェーズの単体テスト実装** ← 次に実施すべき
   - タイムスタンプフィルタリングの検証
   - タイムスタンプ伝播の検証
   - データ連結の検証
2. 複数デバイス間での統合テスト実装
3. パフォーマンス測定の実施

### 推奨アクション
- BIControllerの各フェーズの単体テストを実装
- 複数デバイス環境での統合テストを実施
- サイクル時間とLLM/TTS速度の測定

---

## 9. 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-02-13 | OUTPUT Phase処理順序の最適化（TTS生成→OSC送信に変更） |
| 2026-02-10 | TTS音声出力のWAVファイル化（v2.1）実装完了 |
| 2026-02-09 | Mixer PC送信機能の実装完了、ドキュメント更新 |
| 2026-02-08 | ドキュメント整理、不要な項目を削除 |
| 2026-02-07 | ドキュメント整理、実装状況に合わせて更新 |
| 2026-02-06 | タイムスタンプ管理の修正完了、タスクリスト更新 |
| 2026-02-06 | タイムスタンプ管理の修正タスクを最優先として追加 |
| 2026-02-06 | 実装状況に合わせてタスクリストを全面更新 |

---

## 10. 参考リンク

- [要件定義書](requirements.md)
- [実装計画書](plan.md)
- [README.md](../README.md)
- [CLAUDE.md](../CLAUDE.md)

---

**このタスクリストは実装の進捗に応じて随時更新されます。**
