# 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
CCBT-2025-Parallel-Botanical-Garden-Proto

### 1.2 目的
M5Stack LLM Compute Kit上で動作する分散型音声対話システム。複数のBotanical Intelligence（BI）デバイスがOSC経由で相互通信しながら、LLMによる協調的な詩的テキスト生成とTTSによる音声出力を行う。

### 1.3 動作環境
- **ハードウェア**: M5Stack LLM630 Compute Kit
- **OS**: Ubuntu (ARM64)
- **言語**: Python 3.10以上
- **通信**: OSC (UDP), TCP

---

## 2. システムアーキテクチャ

### 2.1 デバイスの役割

全てのBIデバイスは同一の動作を行います：
- 他のBIデバイスからの信号を受け付ける
- 人間の声（マイク入力）を受け付ける
- 入力: `{timestamp, text, source_type, lang}`
  - `source_type`: "HUMAN"（人間からの入力）または "BI"（他のBIからの入力）

**注意**: どのBIデバイスにも人間の入力を送ることができます。システムはデバイスの種類を区別せず、入力元（source_type）のみを記録します。

### 2.2 動作サイクル

各BIデバイスは独立した4段階のサイクルで動作：

```
1. 入力受付期間（3秒）
   ↓ OSC経由で入力データを受け付け（複数可）
   ↓ 受信時に古いタイムスタンプのデータは即座に破棄

2. 生成期間
   ↓ 入力データを時系列順に連結
   ↓ LLMで続きのテキストを生成（2~3トークン）

3. 出力期間
   ↓ バッファが空の場合はスキップ
   ↓ 生成テキストをOSC送信（次のBIへ）
   ↓ 全入力+生成をTTS音声再生

4. 休息期間（1秒）
   ↓ 待機

→ サイクル1に戻る
```

### 2.3 タイムスタンプ管理仕様

**タイムスタンプの発行と伝播**

1. **タイムスタンプの発行元**
   - **人間からの入力時のみ**、新しいタイムスタンプを発行
   - BIデバイスが人間の音声を受け取った時点でUNIXタイムスタンプを生成

2. **タイムスタンプの伝播**
   - BIが他のBIに信号を送る際は、**元のタイムスタンプをそのまま使用**
   - バッファ内に複数の入力がある場合、**最も新しい（最大値の）タイムスタンプ**を次のBIへ送信

3. **古いデータのフィルタリング**
   - データ受信時（`add_input()`呼び出し時）に即座にチェック
   - 現在時刻との差分が`max_data_age`（デフォルト60秒）を超える場合、そのデータを破棄
   - フィルタリングは受信の都度実行される

**データフロー例**

```
[人間] --timestamp:100--> [BI-A] --timestamp:100--> [BI-B] --timestamp:100--> [BI-C]
  ↑                          ↑                         ↑
新規発行                   保持して転送              保持して転送
```

**複数入力時の処理**

```
[BI-A のバッファ]
- Input A (timestamp: 100, text: "こんにちは")
- Input B (timestamp: 105, text: "今日は")  ← 最新

→ 連結テキスト: "こんにちは今日は晴れです" (LLMで「晴れです」を生成)
→ 次のBIへ送信: timestamp=105, text="晴れです"  ← 最新のタイムスタンプを使用
```

**理由**: 最新のタイムスタンプを使用することで、データの鮮度を正確に反映し、古いデータとして誤って破棄されるリスクを低減する

---

## 3. 主要機能

### 3.1 LLM推論
- **モデル**: qwen2.5-0.5B-prefill-20e
- **出力**: 最大128トークン（通常2~3トークン）
- **プロンプト**: 詩的な短文生成に特化
- **Soft Prefix**: bf16形式のプリフィックスチューニング対応

### 3.2 TTS音声合成
- **モデル**: MeloTTS (日本語/英語/中国語)
- **フォーマット**: PCMストリーム
- **音量**: デフォルト15%

### 3.3 OSC通信

#### 受信エンドポイント（UDP: 8000）
| エンドポイント | 引数 | 機能 |
|------------|------|------|
| `/bi/input` | timestamp, text, source_type, lang | 入力データ受付 |
| `/bi/stop` | なし | サイクル停止 |
| `/bi/status` | なし | ステータス取得 |

**注意**: サイクルはアプリケーション起動時に自動開始されます。

#### 送信
- **BIデバイス間通信**: `/bi/input` 経由で次のBIデバイスへ生成テキストを送信
  - 送信先: 設定ファイル（networks.csv）で指定
  - 送信内容: `timestamp, generated_text, "BI", lang`
- **Mixer PC送信**: `/mixer` 経由で生成テキストを送信
  - 送信先: config.json の `mixer` セクションで指定
  - 送信内容: `generated_text` のみ
  - 送信タイミング: LLM生成成功時に毎回送信

---

## 4. 設定ファイル構造

### 4.1 config/config.json

デバイス固有の設定を記述：

```json
{
  "network": {
    "device_id": 1,                    // 自分のデバイスID
    "csv_path": "config/networks.csv"  // ネットワーク設定CSVのパス
  },
  "cycle": {
    "receive_duration": 3.0,  // 入力受付期間（秒）
    "rest_duration": 1.0,     // 休息期間（秒）
    "max_data_age": 60.0      // データ有効期限（秒）
  },
  "osc": {
    "receive_port": 8000
  },
  "mixer": {
    "host": "10.0.0.200",    // Mixer PCのIPアドレス
    "port": 8000             // Mixer PCのOSCポート
  },
  "common": {
    "lang": "ja"  // "en", "zh", "fr"
  },
  "stack_flow_llm": {
    "max_tokens": 128
  }
}
```

### 4.2 config/networks.csv

全デバイスのネットワーク情報を一元管理：

```csv
ID,IP,To
1,10.0.0.1,"2,5"
2,10.0.0.2,"3,6"
3,10.0.0.3,"4,7"
...
```

- **ID**: デバイスID
- **IP**: デバイスのIPアドレス（ルール: ID X → 10.0.0.X）
- **To**: 送信先デバイスIDのカンマ区切りリスト

**設定の仕組み**:
1. config.jsonで自分のdevice_idを指定
2. 起動時にnetworks.csvから該当IDの情報を読み込み
3. IPアドレスと送信先が自動的に解決される

---

## 5. 依存関係

### Pythonライブラリ
- loguru (ロギング)
- python-osc (OSCプロトコル)
- argostranslate (オフライン翻訳) ※現在未使用、将来的なオプション機能として保持
- googletrans (Google翻訳API) ※現在未使用、将来的なオプション機能として保持

### StackFlowモデル
- llm-model-qwen2.5-0.5B-prefill-20e
- llm-model-melotts-ja-jp
- llm-model-melotts-en-us
- llm-model-melotts-zh-cn

---

## 6. 非機能要件

### 6.1 性能
- サイクル時間: 約5~8秒（3秒受付 + 生成 + 出力 + 1秒休息）
- LLM推論: 1秒以内
- TTS生成: 1秒以内に再生開始

### 6.2 信頼性
- 継続動作（無限サイクル）
- StackFlow接続エラー時の自動再接続
- loguru による詳細ログ出力

### 6.3 拡張性
- 言語追加が容易
- 設定ファイルでモデル切り替え可能
- 送信先デバイスの動的追加

---

## 7. 制約事項

### 技術的制約
- M5Stack LLM Compute Kitでのみ動作
- StackFlow APIに依存
- オフライン動作（翻訳モデルがインストール済みの場合）

### 機能的制約
- LLM出力は最大64トークン
- TTS音声はリアルタイム再生のみ（ファイル保存なし）
- OSCプロトコルのみ対応
